# Android Base App - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¬ã‚¤ãƒ‰

> æ–°è¦å‚ç”»è€…å‘ã‘åŸºæœ¬æ§‹æˆèª¬æ˜ãŠã‚ˆã³æ©Ÿèƒ½æ‹¡å¼µæ™‚ã®è¨­è¨ˆæ–¹é‡

## Architecture1: å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆClean Architecture + MVVMï¼‰

```mermaid
graph TB
    %% =================================================================
    %% PRESENTATION LAYER - UIè¡¨ç¤ºã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ
    %% =================================================================
    subgraph PresentationLayer ["ğŸ–¥ï¸ Presentation Layer - UIè¡¨ç¤ºã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ"]
        direction TB
        
        subgraph Screens ["ğŸ“± ç”»é¢ (Composable)"]
            Screen["Screen<br/>Jetpack Compose UI<br/>ãƒ»ãƒªã‚¹ãƒˆè¡¨ç¤º<br/>ãƒ»ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›<br/>ãƒ»ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³"]
        end
        
        subgraph ViewModels ["ğŸ§  ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ç®¡ç†"]
            ViewModel["ViewModel<br/>StateFlow + UiStateç®¡ç†<br/>ãƒ»ç”»é¢çŠ¶æ…‹åˆ¶å¾¡<br/>ãƒ»Domainå±¤é€£æº"]
        end
        
        subgraph UIState ["ğŸ“Š UIçŠ¶æ…‹å®šç¾©"]
            UiStateClasses["UiState<br/>Loading/Success/Error/Empty<br/>ãƒ»ç”»é¢è¡¨ç¤ºçŠ¶æ…‹<br/>ãƒ»ã‚¨ãƒ©ãƒ¼æƒ…å ±"]
        end
        
        Screen --> ViewModel
        ViewModel --> UiStateClasses
    end
    
    %% =================================================================
    %% DOMAIN LAYER - ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã¨æŠ½è±¡åŒ–
    %% =================================================================
    subgraph DomainLayer ["ğŸ¯ Domain Layer - ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã¨æŠ½è±¡åŒ–"]
        direction TB
        
        subgraph Interfaces ["ğŸ”Œ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©"]
            Repository["Repository Interface<br/>ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æŠ½è±¡åŒ–<br/>ãƒ»CRUDæ“ä½œå®šç¾©<br/>ãƒ»Flowå‹æˆ»ã‚Šå€¤"]
        end
        
        subgraph Models ["ğŸ“‹ ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«"]
            DomainModel["Domain Models<br/>ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ<br/>ãƒ»ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¯ãƒ©ã‚¹<br/>ãƒ»ãƒ”ãƒ¥ã‚¢ãªãƒ‡ãƒ¼ã‚¿"]
            ValueObject["Value Objects<br/>å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ<br/>ãƒ»ä¸å¤‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ<br/>ãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«"]
            ErrorModel["Error Models<br/>ã‚¨ãƒ©ãƒ¼å®šç¾©<br/>ãƒ»å‹å®‰å…¨ãªã‚¨ãƒ©ãƒ¼<br/>ãƒ»ã‚¨ãƒ©ãƒ¼åˆ†é¡"]
        end
        
        subgraph UseCases ["âš™ï¸ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)"]
            UseCase["Use Cases<br/>è¤‡é›‘ãªãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯<br/>ãƒ»è¤‡æ•°Repositoryé€£æº<br/>ãƒ»ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†"]
        end
        
        Repository --> Models
        UseCase --> Repository
        UseCase --> Models
    end
    
    %% =================================================================
    %% DATA LAYER - ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨æ°¸ç¶šåŒ–
    %% =================================================================
    subgraph DataLayer ["ğŸ’¾ Data Layer - ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨æ°¸ç¶šåŒ–"]
        direction TB
        
        subgraph Implementation ["ğŸ—ï¸ Repositoryå®Ÿè£…"]
            RepositoryImpl["Repository Implementation<br/>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹èª¿æ•´<br/>ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥<br/>ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ"]
        end
        
        subgraph RemoteDataSource ["ğŸŒ ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹"]
            API["API Service (Retrofit)<br/>REST APIå‘¼ã³å‡ºã—<br/>ãƒ»HTTPé€šä¿¡<br/>ãƒ»èªè¨¼å‡¦ç†"]
            DTO["DTOs<br/>API ãƒ¬ã‚¹ãƒãƒ³ã‚¹/ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<br/>ãƒ»JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³<br/>ãƒ»APIä»•æ§˜æº–æ‹ "]
            ErrorHandler["Error Handler<br/>ã‚¨ãƒ©ãƒ¼å¤‰æ›<br/>ãƒ»HTTP ã‚¨ãƒ©ãƒ¼<br/>ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼"]
        end
        
        subgraph LocalDataSource ["ğŸ—„ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹"]
            DAO["DAO (Room)<br/>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ<br/>ãƒ»CRUD Query<br/>ãƒ»Flowå¯¾å¿œ"]
            Entity["Entities<br/>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«<br/>ãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©<br/>ãƒ»ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"]
            Database["Database (Room)<br/>DBè¨­å®šã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³<br/>ãƒ»ã‚¹ã‚­ãƒ¼ãƒç®¡ç†<br/>ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†"]
        end
        
        subgraph DataTransformation ["ğŸ”„ ãƒ‡ãƒ¼ã‚¿å¤‰æ›"]
            Mapper["Data Mappers<br/>DTO/Entity â†” Domainå¤‰æ›<br/>ãƒ»å‹å®‰å…¨ãªå¤‰æ›<br/>ãƒ»ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–"]
        end
        
        RepositoryImpl --> API
        RepositoryImpl --> DAO
        API --> DTO
        DAO --> Entity
        Entity --> Database
        DTO --> Mapper
        Entity --> Mapper
        Mapper --> Models
        API --> ErrorHandler
        ErrorHandler --> ErrorModel
    end
    
    %% =================================================================
    %% DI LAYER - ä¾å­˜æ€§æ³¨å…¥è¨­å®š
    %% =================================================================
    subgraph DILayer ["âš™ï¸ DI Layer - ä¾å­˜æ€§æ³¨å…¥è¨­å®š"]
        direction LR
        NetworkModule["Network Module<br/>Retrofit/OkHttpè¨­å®š<br/>ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ<br/>ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼"]
        DatabaseModule["Database Module<br/>Room DBè¨­å®š<br/>ãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³<br/>ãƒ»DAOæä¾›"]
        RepositoryModule["Repository Module<br/>Repository binding<br/>ãƒ»å®Ÿè£…ãƒã‚¤ãƒ³ãƒ‰<br/>ãƒ»Singletonç®¡ç†"]
    end
    
    %% =================================================================
    %% ä¾å­˜é–¢ä¿‚ã®å®šç¾©
    %% =================================================================
    %% ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ã®ä¾å­˜é–¢ä¿‚
    ViewModel --> Repository
    ViewModel -.optional.-> UseCase
    
    Repository --> RepositoryImpl
    
    %% DI ã«ã‚ˆã‚‹æä¾›
    NetworkModule -.provides.-> API
    DatabaseModule -.provides.-> DAO
    DatabaseModule -.provides.-> Database
    RepositoryModule -.binds.-> RepositoryImpl
    
    %% =================================================================
    %% ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°å®šç¾© - VSCodeå¯¾å¿œã§æ¿ƒã„è‰²ã«å¤‰æ›´
    %% =================================================================
    classDef presentationStyle fill:#1976d2,stroke:#0d47a1,stroke-width:3px,color:#ffffff
    classDef domainStyle fill:#6a1b9a,stroke:#4a148c,stroke-width:3px,color:#ffffff
    classDef dataStyle fill:#2e7d32,stroke:#1b5e20,stroke-width:3px,color:#ffffff
    classDef diStyle fill:#ef6c00,stroke:#e65100,stroke-width:3px,color:#ffffff
    classDef interfaceStyle fill:#c2185b,stroke:#880e4f,stroke-width:3px,color:#ffffff
    
    class Screen,ViewModel,UiStateClasses presentationStyle
    class Models,DomainModel,ValueObject,ErrorModel domainStyle
    class RepositoryImpl,API,DTO,DAO,Entity,Database,Mapper,ErrorHandler dataStyle
    class NetworkModule,DatabaseModule,RepositoryModule diStyle
    class Repository,Interfaces interfaceStyle
    class UseCase,UseCases domainStyle
```

### ğŸ“‹ å„å±¤ã®è©³ç´°èª¬æ˜

#### ğŸ–¥ï¸ Presentation Layer (ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤)
- **è²¬ä»»**: 
  - UIè¡¨ç¤ºã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã€ç”»é¢çŠ¶æ…‹ç®¡ç†
- **Screen (Composable)**: 
  - UIæç”»ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
  - Pull to Refreshã€ãƒªã‚¹ãƒˆè¡¨ç¤ºã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡
- **ViewModel**: 
  - ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã¨UIçŠ¶æ…‹ã®ä»²ä»‹
  - StateFlow ã«ã‚ˆã‚‹çŠ¶æ…‹ç®¡ç†ã€Domainå±¤ã¨ã®é€£æº
- **UiState**: 
  - ç”»é¢çŠ¶æ…‹ã®å®šç¾© (Loading/Success/Error/Empty)

#### ğŸ¯ Domain Layer (ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤)
- **è²¬ä»»**: 
  - ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã€æŠ½è±¡åŒ–
- **Repository Interface**: 
  - ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®æŠ½è±¡åŒ–
  - Dataå±¤ã®å®Ÿè£…è©³ç´°ã‚’éš è”½
- **Domain Models**: 
  - ãƒ‰ãƒ¡ã‚¤ãƒ³æ¦‚å¿µã®è¡¨ç¾
  - User, Address, AppErrorç­‰ã®ãƒ”ãƒ¥ã‚¢ãªãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹
- **Use Cases (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)**: 
  - è¤‡é›‘ãªãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
  - è¤‡æ•°Repositoryã‚’çµ„ã¿åˆã‚ã›ã‚‹å ´åˆã‚„è¤‡é›‘ãªå‡¦ç†

#### ğŸ’¾ Data Layer (ãƒ‡ãƒ¼ã‚¿å±¤)
- **è²¬ä»»**: 
  - ãƒ‡ãƒ¼ã‚¿å–å¾—ã€æ°¸ç¶šåŒ–ã€ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ç®¡ç†
- **Repository Implementation**: 
  - Domainå±¤ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å®Ÿè£…
  - Remote/Local ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®èª¿æ•´ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
- **Remote Data Source**: 
  - APIé€šä¿¡
  - Retrofit, DTOs, ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- **Local Data Source**: 
  - ãƒ­ãƒ¼ã‚«ãƒ«æ°¸ç¶šåŒ–
  - Room DB, Entities, DAO
- **Data Mappers**: 
  - ãƒ‡ãƒ¼ã‚¿å¤‰æ›
  - DTO â†” Domain, Entity â†” Domain

#### âš™ï¸ DI Layer (ä¾å­˜æ€§æ³¨å…¥å±¤)
- **è²¬ä»»**: 
  - ä¾å­˜é–¢ä¿‚ã®è¨­å®šã¨æä¾›
- **å„Module**: 
  - ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ç”Ÿæˆã¨æä¾›
  - Singletonç®¡ç†ã€ãƒ†ã‚¹ãƒˆæ™‚ã®å·®ã—æ›¿ãˆ


## Architecture2: ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆåŸå‰‡

```mermaid
sequenceDiagram
    participant UI as UI Screen
    participant VM as ViewModel
    participant Repo as Repository
    participant API as Remote API
    participant DB as Local DB
    
    Note over UI,DB: æ¨™æº–çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
    
    UI->>VM: User Action
    VM->>Repo: Business Logic Request
    
    alt Fresh Data Needed
        Repo->>API: Fetch from Remote
        API-->>Repo: Response Data
        Repo->>DB: Cache Data
    else Cache Valid
        Repo->>DB: Read from Cache
    end
    
    DB-->>Repo: Domain Models
    Repo-->>VM: Flow DomainModel
    VM->>VM: Transform to UiState
    VM-->>UI: StateFlow UiState
    UI->>UI: Recomposition
```

## Architecture7: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ•ãƒ­ãƒ¼

### ğŸ“Š ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®éšå±¤æ§‹é€ ã¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TB
    subgraph DataLayer ["ğŸ’¾ Dataå±¤ï¼ˆã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæºï¼‰"]
        API[("ğŸŒ APIé€šä¿¡<br/>ãƒ»Network Exception<br/>ãƒ»HTTP Error Codes<br/>ãƒ»Timeout")]
        DB[("ğŸ—„ï¸ Database<br/>ãƒ»SQL Exception<br/>ãƒ»Constraint Violation")]
        Cache[("ğŸ“¦ Cache<br/>ãƒ»Expired Data<br/>ãƒ»Invalid State")]
    end
    
    subgraph ErrorCatchLayer ["ğŸ”„ Repositoryå±¤ï¼ˆResult APIï¼‰"]
        ResultAPI["Result API<br/>ãƒ»runCatchingã§å®‰å…¨å®Ÿè¡Œ<br/>ãƒ»safeApiCallæ‹¡å¼µé–¢æ•°"]
        ErrorMapper["Error Mapper<br/>ãƒ»Exception â†’ AppErrorå¤‰æ›<br/>ãƒ»mapWithErroræ‹¡å¼µé–¢æ•°"]
    end
    
    subgraph DomainErrorLayer ["ğŸ¯ Domainå±¤ï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¾ï¼‰"]
        AppErrorClass["sealed class AppError<br/>â”œâ”€ NetworkError<br/>â”œâ”€ TimeoutError<br/>â”œâ”€ OfflineError<br/>â””â”€ UnknownError"]
        ErrorAttributes["ã‚¨ãƒ©ãƒ¼å±æ€§<br/>ãƒ»message: String<br/>ãƒ»code: Int?<br/>ãƒ»isRetryable: Boolean"]
    end
    
    subgraph ViewModelLayer ["ğŸ§  ViewModelå±¤ï¼ˆã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼‰"]
        ErrorState["Error Stateç®¡ç†<br/>ãƒ»UiState.Error(appError)<br/>ãƒ»canRetryåˆ¤å®š"]
        RetryLogic["ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯<br/>ãƒ»å†å®Ÿè¡Œå¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯<br/>ãƒ»ãƒªãƒˆãƒ©ã‚¤å›æ•°ç®¡ç†"]
    end
    
    subgraph UILayer ["ğŸ–¥ï¸ UIå±¤ï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼‰"]
        ErrorDialog["AlertDialog<br/>ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º<br/>ãƒ»ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³æœ‰ç„¡"]
    end
    
    %% ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å®šç¾©
    API --> ResultAPI
    DB --> ResultAPI
    Cache --> ResultAPI
    
    ResultAPI --> ErrorMapper
    ErrorMapper --> AppErrorClass
    AppErrorClass --> ErrorAttributes
    
    AppErrorClass --> ErrorState
    ErrorAttributes --> ErrorState
    ErrorState --> RetryLogic
    
    ErrorState --> ErrorDialog
    RetryLogic --> ErrorDialog
    
    %% ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° - VSCodeå¯¾å¿œ
    classDef dataStyle fill:#d32f2f,stroke:#b71c1c,stroke-width:3px,color:#ffffff
    classDef catchStyle fill:#f57c00,stroke:#e65100,stroke-width:3px,color:#ffffff
    classDef domainStyle fill:#7b1fa2,stroke:#4a148c,stroke-width:3px,color:#ffffff
    classDef viewModelStyle fill:#388e3c,stroke:#1b5e20,stroke-width:3px,color:#ffffff
    classDef uiStyle fill:#1976d2,stroke:#0d47a1,stroke-width:3px,color:#ffffff
    
    class API,DB,Cache dataStyle
    class ResultAPI,ErrorMapper catchStyle
    class AppErrorClass,ErrorAttributes domainStyle
    class ErrorState,RetryLogic viewModelStyle
    class ErrorDialog uiStyle
```

### ğŸ” ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®è©³ç´°èª¬æ˜

1. **Dataå±¤ï¼ˆç™ºç”Ÿæºï¼‰**: 
   - å„ç¨®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã§ä¾‹å¤–ãŒç™ºç”Ÿ
   - Networkã€Databaseã€Cacheãã‚Œãã‚Œå›ºæœ‰ã®ã‚¨ãƒ©ãƒ¼

2. **Repositoryå±¤ï¼ˆResult APIã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰**:
   - **try-catchã‚’ä½¿ã‚ãš**ã€Kotlinæ¨™æº–ã®Result APIã‚’æ´»ç”¨
   - `runCatching`ã§ã‚¨ãƒ©ãƒ¼ã‚’å®‰å…¨ã«ã‚­ãƒ£ãƒƒãƒ
   - æ‹¡å¼µé–¢æ•°ã§Exceptionç¨®åˆ¥ã«å¿œã˜ã¦AppErrorã«å¤‰æ›
   ```kotlin
   // Result APIã‚’ä½¿ç”¨ã—ãŸå®Ÿè£…ä¾‹
   suspend fun refreshUsers(): Result<Unit> {
       // å›³ã®ã€ŒResult APIã€å±¤ - safeApiCallã§å®‰å…¨å®Ÿè¡Œ
       return safeApiCall { userApi.getUsers() }
           // å›³ã®ã€ŒError Mapperã€å±¤ - mapWithErrorã§ã‚¨ãƒ©ãƒ¼å¤‰æ›
           .mapWithError { userDtos ->
               // ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã¨DBä¿å­˜å‡¦ç†
               val users = userDtos.map { it.toDomain() }
               val entities = users.map { it.toEntity() }
               
               userDao.deleteAllUsers()
               userDao.insertUsers(entities)
               Unit
           }
   }
   ```

3. **Domainå±¤ï¼ˆè¡¨ç¾ï¼‰**:
   - sealed classã§å‹å®‰å…¨ãªã‚¨ãƒ©ãƒ¼è¡¨ç¾
   - ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã«å¿œã˜ãŸåˆ†é¡

4. **ViewModelå±¤ï¼ˆå‡¦ç†ï¼‰**:
   - Resultå‹ã®onSuccess/onFailureã§å‡¦ç†ã‚’åˆ†å²
   - **ErrorMessageProvider**ã§AppErrorã‚’ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›
   - ãƒªãƒˆãƒ©ã‚¤å¯èƒ½æ€§ã®åˆ¤å®š
   ```kotlin
   // ErrorMessageProviderã‚’ä½¿ç”¨ã—ãŸå®Ÿè£…ä¾‹
   .onFailure { throwable ->
       // å›³ã®ã€ŒViewModelå±¤ã€ - Error Stateç®¡ç†
       val appError = if (throwable is AppErrorException) {
           throwable.appError
       } else {
           // å›³ã®ã€ŒDomainå±¤ã€ - AppErrorã‚¯ãƒ©ã‚¹ã§ã‚¨ãƒ©ãƒ¼è¡¨ç¾
           AppError.UnknownError(throwable.message ?: "Unknown error")
       }
       // å›³ã®ã€ŒUIå±¤ã€ã«æ¸¡ã™ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
       _errorMessage.value = errorMessageProvider.getErrorMessage(appError)
       // å›³ã®ã€ŒViewModelå±¤ã€ - ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
       _canRetry.value = appError.canRetry()
   }
   ```

5. **UIå±¤ï¼ˆè¡¨ç¤ºï¼‰**:
   - ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã«å¿œã˜ãŸé©åˆ‡ãªUIè¡¨ç¤º
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒªãƒˆãƒ©ã‚¤ç­‰ï¼‰ã®å‡¦ç†

### ğŸ“‹ ErrorMessageProviderãƒ‘ã‚¿ãƒ¼ãƒ³

**Clean Architectureã«æº–æ‹ ã—ãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†**:

- **Domainå±¤**: `ErrorMessageProvider` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§æŠ½è±¡åŒ–
- **Presentationå±¤**: `AndroidErrorMessageProvider` ã§String Resourcesä½¿ç”¨
- **DI**: ä¾å­˜é–¢ä¿‚ã®é€†è»¢ã§Platformå›ºæœ‰å®Ÿè£…ã‚’æ³¨å…¥
- **åˆ©ç‚¹**: Domainå±¤ãŒAndroidå›ºæœ‰ã«ä¾å­˜ã›ãšã€ãƒ†ã‚¹ãƒˆã‚‚å®¹æ˜“ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸€å…ƒç®¡ç†

## Architecture5: DIè¨­è¨ˆæ–¹é‡ï¼ˆHiltï¼‰

### ğŸ”Œ ä¾å­˜æ€§æ³¨å…¥ã®åŸºæœ¬æ¦‚å¿µ

**DIï¼ˆDependency Injectionï¼‰** ã¯ã€ã‚¯ãƒ©ã‚¹ãŒå¿…è¦ã¨ã™ã‚‹ä¾å­˜é–¢ä¿‚ã‚’å¤–éƒ¨ã‹ã‚‰æ³¨å…¥ã™ã‚‹è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ä»¥ä¸‹ã®åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ï¼š

- **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**: Mockå®Ÿè£…ã‚’ç°¡å˜ã«å·®ã—æ›¿ãˆå¯èƒ½
- **ç–çµåˆ**: å…·ä½“çš„ãªå®Ÿè£…ã«ä¾å­˜ã—ãªã„
- **å†åˆ©ç”¨æ€§**: åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§è¤‡æ•°ã®å®Ÿè£…ã‚’ä½¿ã„åˆ†ã‘
- **ä¿å®ˆæ€§**: è¨­å®šã‚’ä¸€ç®‡æ‰€ã§ç®¡ç†

```mermaid
flowchart LR
    subgraph WithoutDI ["âŒ DIä½¿ç”¨å‰ï¼ˆå•é¡Œã‚ã‚Šï¼‰"]
        VM1["ViewModel"] -->|ç›´æ¥ç”Ÿæˆ| Repo1["Repositoryå®Ÿè£…"]
        Repo1 -->|ç›´æ¥ç”Ÿæˆ| API1["APIå®Ÿè£…"]
        Repo1 -->|ç›´æ¥ç”Ÿæˆ| DB1["DBå®Ÿè£…"]
        
        Note1["å•é¡Œç‚¹:<br/>ãƒ»ãƒ†ã‚¹ãƒˆå›°é›£<br/>ãƒ»å®Ÿè£…ã®å·®ã—æ›¿ãˆä¸å¯<br/>ãƒ»ä¾å­˜é–¢ä¿‚ãŒå¯†çµåˆ"]
    end
    
    subgraph WithDI ["âœ… DIä½¿ç”¨å¾Œï¼ˆHiltï¼‰"]
        VM2["ViewModel"] -->|æ³¨å…¥ã•ã‚Œã‚‹| RepoInterface["Repository<br/>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹"]
        
        Hilt["Hilt<br/>ï¼ˆDIã‚³ãƒ³ãƒ†ãƒŠï¼‰"] -->|å®Ÿè£…ã‚’æä¾›| RepoInterface
        
        RepoImpl["Repositoryå®Ÿè£…"] -.->|å®Ÿè£…| RepoInterface
        RepoImpl -->|æ³¨å…¥ã•ã‚Œã‚‹| APIInterface["API"]
        RepoImpl -->|æ³¨å…¥ã•ã‚Œã‚‹| DBInterface["DB"]
        
        Note2["åˆ©ç‚¹:<br/>ãƒ»ãƒ†ã‚¹ãƒˆæ™‚ã¯Mockæ³¨å…¥<br/>ãƒ»å®Ÿè£…ã®å·®ã—æ›¿ãˆå¯èƒ½<br/>ãƒ»ç–çµåˆ"]
    end
    
    %% ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
    classDef problemStyle fill:#d32f2f,stroke:#b71c1c,stroke-width:3px,color:#ffffff
    classDef solutionStyle fill:#388e3c,stroke:#1b5e20,stroke-width:3px,color:#ffffff
    classDef interfaceStyle fill:#1976d2,stroke:#0d47a1,stroke-width:3px,color:#ffffff
    classDef hiltStyle fill:#f57c00,stroke:#e65100,stroke-width:3px,color:#ffffff
    
    class VM1,Repo1,API1,DB1,Note1 problemStyle
    class VM2,RepoImpl,Note2 solutionStyle
    class RepoInterface,APIInterface,DBInterface interfaceStyle
    class Hilt hiltStyle
```

### ğŸ¯ DIï¼ˆä¾å­˜æ€§æ³¨å…¥ï¼‰ã¨ã¯ï¼Ÿ

**ã‚¯ãƒ©ã‚¹ãŒå¿…è¦ã¨ã™ã‚‹éƒ¨å“ã‚’å¤–éƒ¨ã‹ã‚‰æ¸¡ã™ä»•çµ„ã¿**ã§ã™ã€‚

#### ä¾‹ï¼šViewModelãŒRepositoryã‚’ä½¿ã†å ´åˆ

**âŒ DIä½¿ç”¨å‰ï¼ˆå•é¡Œã‚ã‚Šï¼‰**
```kotlin
class UserListViewModel {
    // å›³ã®ã€ŒâŒ DIä½¿ç”¨å‰ã€ - ViewModelãŒç›´æ¥Repositoryã‚’ç”Ÿæˆ
    private val repository = UserRepositoryImpl(
        UserApi(),      // ç›´æ¥ç”Ÿæˆï¼ˆå›³ã®å•é¡Œç‚¹ï¼šå¯†çµåˆï¼‰
        UserDao()       // ç›´æ¥ç”Ÿæˆï¼ˆå›³ã®å•é¡Œç‚¹ï¼šãƒ†ã‚¹ãƒˆå›°é›£ï¼‰
    )
}
```

**âœ… DIä½¿ç”¨å¾Œï¼ˆHiltï¼‰**
```kotlin
@HiltViewModel
class UserListViewModel @Inject constructor(
    // å›³ã®ã€Œâœ… DIä½¿ç”¨å¾Œã€ - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æ³¨å…¥ã•ã‚Œã‚‹
    private val repository: UserRepository  // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æ³¨å…¥
) : ViewModel()

// å›³ã®ã€ŒHiltï¼ˆDIã‚³ãƒ³ãƒ†ãƒŠï¼‰ã€ãŒå®Ÿè£…ã‚’ç®¡ç†
@Module
abstract class RepositoryModule {
    @Binds
    @Singleton
    abstract fun bindUserRepository(
        impl: UserRepositoryImpl  // å›³ã®ã€ŒRepositoryå®Ÿè£…ã€
    ): UserRepository  // å›³ã®ã€ŒRepository ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€
}
```

### ğŸ”§ Hiltã‚’ä½¿ã£ãŸå®Ÿè£…æ§‹æˆ

```mermaid
flowchart TD
    subgraph HiltModules ["Hiltãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ"]
        NetworkModule["NetworkModule<br/>ãƒ»Retrofitæä¾›<br/>ãƒ»APIè¨­å®š"]
        DatabaseModule["DatabaseModule<br/>ãƒ»Room DBæä¾›<br/>ãƒ»DAOæä¾›"]
        RepositoryModule["RepositoryModule<br/>ãƒ»Repositoryå®Ÿè£…ã‚’<br/>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«çµåˆ"]
        ProviderModule["ProviderModule<br/>ãƒ»ErrorMessageProvider<br/>ãªã©ã®æä¾›"]
    end
    
    subgraph Usage ["ä½¿ç”¨ä¾‹"]
        NetworkModule -->|APIæä¾›| RepositoryImpl["Repositoryå®Ÿè£…"]
        DatabaseModule -->|DAOæä¾›| RepositoryImpl
        RepositoryModule -->|Repositoryæä¾›| ViewModel
        ProviderModule -->|Provideræä¾›| ViewModel
    end
    
    %% ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
    classDef moduleStyle fill:#1976d2,stroke:#0d47a1,stroke-width:3px,color:#ffffff
    classDef usageStyle fill:#388e3c,stroke:#1b5e20,stroke-width:3px,color:#ffffff
    
    class NetworkModule,DatabaseModule,RepositoryModule,ProviderModule moduleStyle
    class RepositoryImpl,ViewModel usageStyle
```

### ğŸ“‹ é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

1. **ä¾å­˜é–¢ä¿‚ã¯è‡ªå‹•ç®¡ç†**: `@Inject`ã‚’ä»˜ã‘ã‚‹ã ã‘ã§å¿…è¦ãªéƒ¨å“ãŒæ³¨å…¥ã•ã‚Œã‚‹
2. **ãƒ†ã‚¹ãƒˆãŒç°¡å˜**: ãƒ†ã‚¹ãƒˆæ™‚ã¯Mockå®Ÿè£…ã«å·®ã—æ›¿ãˆå¯èƒ½
3. **è¨­å®šã¯ä¸€ç®‡æ‰€**: Moduleå†…ã§ä¾å­˜é–¢ä¿‚ã‚’ä¸€å…ƒç®¡ç†
4. **å®Ÿè£…ã®è©³ç´°ã‚’éš è”½**: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ã£ã¦ç–çµåˆã‚’å®Ÿç¾

## Architecture6: UIçŠ¶æ…‹ç®¡ç†ãƒ‘ã‚¿ãƒ¼ãƒ³

### ğŸ¯ çŠ¶æ…‹ç®¡ç†ã®åŸºæœ¬åŸå‰‡

**UIçŠ¶æ…‹ç®¡ç†** ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç”»é¢çŠ¶æ…‹ã‚’äºˆæ¸¬å¯èƒ½ã§ä¸€è²«æ€§ã®ã‚ã‚‹æ–¹æ³•ã§ç®¡ç†ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚ä»¥ä¸‹ã®åŸå‰‡ã«å¾“ã„ã¾ã™ï¼š

- **Single Source of Truth**: å˜ä¸€ã®çœŸå®Ÿã®æƒ…å ±æº
- **Unidirectional Data Flow**: å˜æ–¹å‘ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
- **Immutable State**: ä¸å¤‰ã®çŠ¶æ…‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- **Reactive Programming**: ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªçŠ¶æ…‹å¤‰æ›´

```mermaid
flowchart TD
    StateManagementPrinciples["ğŸ“ çŠ¶æ…‹ç®¡ç†åŸå‰‡<br/><br/><b>UIçŠ¶æ…‹ç®¡ç†ã®3ã¤ã®åŸºæœ¬ãƒ«ãƒ¼ãƒ«</b><br/><br/>1. å˜ä¸€ã®çœŸå®Ÿã®æƒ…å ±æº<br/>ã€€ã€€- ViewModelå†…ã§çŠ¶æ…‹ç®¡ç†<br/>ã€€ã€€- é‡è¤‡çŠ¶æ…‹ã®å›é¿<br/><br/>2. å˜æ–¹å‘ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼<br/>ã€€ã€€- ViewModel â†’ UI<br/>ã€€ã€€- UI â†’ ViewModel (Actions)<br/><br/>3. ä¸å¤‰çŠ¶æ…‹<br/>ã€€ã€€- StateFlow + data class<br/>ã€€ã€€- çŠ¶æ…‹å¤‰æ›´ã¯æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ<br/><br/><i>ãªãœå¿…è¦ã‹ï¼šè¤‡æ•°ã®å ´æ‰€ã§çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã¨<br/>ãƒ‡ãƒ¼ã‚¿ã®ä¸æ•´åˆã‚„ãƒã‚°ãŒç™ºç”Ÿã—ã‚„ã™ããªã‚‹</i>"]
    
    UiStateDesignPattern["ğŸ—ï¸ UiState Design Pattern<br/><br/><b>ç”»é¢ãŒå–ã‚Šã†ã‚‹4ã¤ã®çŠ¶æ…‹ã‚’çµ±ä¸€çš„ã«è¡¨ç¾</b><br/><br/>UiState Data Class<br/>â”œâ”€ Loading State (isLoading: Boolean)<br/>â”œâ”€ Success State (data: List&lt;T&gt;)<br/>â”œâ”€ Error State (errorMessage: String?, canRetry: Boolean)<br/>â””â”€ Empty State (isEmpty: Boolean)"]
    
    StateFlowPattern["ğŸ”„ StateFlow Pattern<br/><br/><b>ViewModelã¨UIã®é–“ã§çŠ¶æ…‹ã‚’å®‰å…¨ã«å…±æœ‰</b><br/><br/>å®Ÿè£…ãƒ•ãƒ­ãƒ¼ï¼š<br/>1. _uiState: MutableStateFlow (Private)<br/>2. uiState: StateFlow (Publicèª­ã¿å–ã‚Šå°‚ç”¨)<br/>3. combine for complex state (è¤‡æ•°StateFlowã®çµåˆ)<br/>4. UI Observes StateFlow (collectAsStateã§Observe)"]
    
    SideEffects["âš¡ Side Effects<br/><br/><b>UIæç”»ä»¥å¤–ã®å‡¦ç†ã‚’é©åˆ‡ã«ç®¡ç†</b><br/><br/>LaunchedEffect â†’ One-time events<br/>ã€€ã€€APIå‘¼ã³å‡ºã—ã€Navigation<br/><br/>DisposableEffect â†’ Cleanup actions<br/>ã€€ã€€ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾ã€ãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤<br/><br/>SideEffect â†’ Non-compose calls<br/>ã€€ã€€Analyticsã€Logging"]
    
    %% ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° - VSCodeå¯¾å¿œ
    classDef principleStyle fill:#c2185b,stroke:#880e4f,stroke-width:3px,color:#ffffff
    classDef uiStateStyle fill:#388e3c,stroke:#1b5e20,stroke-width:3px,color:#ffffff
    classDef stateFlowStyle fill:#7b1fa2,stroke:#4a148c,stroke-width:3px,color:#ffffff
    classDef sideEffectStyle fill:#f57c00,stroke:#e65100,stroke-width:3px,color:#ffffff
    
    class StateManagementPrinciples principleStyle
    class UiStateDesignPattern uiStateStyle
    class StateFlowPattern stateFlowStyle
    class SideEffects sideEffectStyle
```

### ğŸ“Š å®Ÿè£…ä¾‹ã®è©³ç´°

#### å›³2: UiState Design Pattern å®Ÿè£…ä¾‹
```kotlin
// å›³2ã§ç¤ºã—ãŸ4ã¤ã®çŠ¶æ…‹ã‚’ViewModelã§ä½¿ç”¨
when {
    uiState.isLoading -> ShowLoadingIndicator()        // Loading Stateå¯¾å¿œ
    uiState.errorMessage != null -> ShowError(uiState.errorMessage)  // Error Stateå¯¾å¿œ
    uiState.isEmpty -> ShowEmptyMessage()              // Empty Stateå¯¾å¿œ
    else -> ShowUserList(uiState.users)                // Success Stateå¯¾å¿œ
}
```

#### å›³3: StateFlow Pattern å®Ÿè£…ä¾‹
```kotlin
// å›³3ã®å®Ÿè£…ãƒ•ãƒ­ãƒ¼ã«å¯¾å¿œ
class UserListViewModel : ViewModel() {
    // 1. _uiState: MutableStateFlow (Private) - å›³3-1å¯¾å¿œ
    private val _uiState = MutableStateFlow(UserListUiState())
    private val _isLoading = MutableStateFlow(false)
    private val _errorMessage = MutableStateFlow<String?>(null)
    
    // 2. uiState: StateFlow (Publicèª­ã¿å–ã‚Šå°‚ç”¨) - å›³3-2å¯¾å¿œ
    // 3. combine for complex state (è¤‡æ•°StateFlowã®çµåˆ) - å›³3-3å¯¾å¿œ
    val uiState: StateFlow<UserListUiState> = combine(
        _uiState,
        _isLoading,
        _errorMessage
    ) { state, loading, error ->
        state.copy(
            isLoading = loading,
            errorMessage = error
        )
    }.stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(5000),
        initialValue = UserListUiState()
    )
    
    // çŠ¶æ…‹ã®æ›´æ–°
    fun loadUsers() {
        _isLoading.value = true
        // ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†...
    }
}

// 4. UI Observes StateFlow (collectAsStateã§Observe) - å›³3-4å¯¾å¿œ
@Composable
fun UserListScreen(viewModel: UserListViewModel) {
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    // uiStateã®å¤‰æ›´ã«å¿œã˜ã¦è‡ªå‹•çš„ã«å†æç”»
}
```

#### å›³4: Side Effects å®Ÿè£…ä¾‹
```kotlin
// LaunchedEffect â†’ One-time events (å›³4å¯¾å¿œ)
@Composable
fun UserScreen(userId: String) {
    LaunchedEffect(userId) {
        // APIå‘¼ã³å‡ºã—ä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå¤‰ã‚ã£ãŸæ™‚ã ã‘å†å®Ÿè¡Œ
        viewModel.loadUser(userId)
    }
}

// DisposableEffect â†’ Cleanup actions (å›³4å¯¾å¿œ)
@Composable
fun LocationScreen() {
    DisposableEffect(Unit) {
        val listener = startLocationUpdates()  // ãƒªã‚½ãƒ¼ã‚¹å–å¾—
        onDispose {
            stopLocationUpdates(listener)      // ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾
        }
    }
}

// SideEffect â†’ Non-compose calls (å›³4å¯¾å¿œ)
@Composable
fun AnalyticsScreen(screenName: String) {
    SideEffect {
        // Analyticsä¾‹ï¼šç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹åº¦ã«è¨˜éŒ²
        analytics.logScreenView(screenName)
    }
}
```

### ğŸ”§ çŠ¶æ…‹ç®¡ç†ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

1. **UiStateè¨­è¨ˆ**: ç”»é¢ã®å…¨çŠ¶æ…‹ã‚’1ã¤ã®data classã§è¡¨ç¾
2. **StateFlowæ´»ç”¨**: ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªçŠ¶æ…‹å¤‰æ›´ã‚’StateFlowã§ç®¡ç†
3. **Side Effectåˆ†é›¢**: å‰¯ä½œç”¨ã¯é©åˆ‡ãªCompose Effectã§å‡¦ç†
4. **çŠ¶æ…‹ã®æœ€å°åŒ–**: å¿…è¦æœ€å°é™ã®çŠ¶æ…‹ã®ã¿ã‚’ä¿æŒ

## Architecture8: Unit Test Guidelines

### ğŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆè¨­è¨ˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

```mermaid
flowchart LR
    subgraph TestPyramid ["ğŸ“ ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰"]
        direction TB
        A["Unit Tests<br/>ãƒ»é«˜é€Ÿå®Ÿè¡Œ<br/>ãƒ»å¤šæ•°å®Ÿè£…<br/>ãƒ»å˜ä¸€æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ"]
        B["Integration Tests<br/>ãƒ»ä¸­ç¨‹åº¦å®Ÿè¡Œ<br/>ãƒ»é©åº¦ãªæ•°<br/>ãƒ»çµåˆãƒ†ã‚¹ãƒˆ"]
        C["UI Tests<br/>ãƒ»ä½é€Ÿå®Ÿè¡Œ<br/>ãƒ»å°‘æ•°å®Ÿè£…<br/>ãƒ»E2Eãƒ†ã‚¹ãƒˆ"]
        
        A --> B
        B --> C
    end
    
    subgraph UnitTestTargets ["ğŸ¯ Unit Testå¯¾è±¡"]
        D["ViewModel Tests<br/>ãƒ»StateFlowå‹•ä½œç¢ºèª<br/>ãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼<br/>ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"]
        E["Repository Tests<br/>ãƒ»ãƒ‡ãƒ¼ã‚¿å¤‰æ›ç¢ºèª<br/>ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ­ã‚¸ãƒƒã‚¯<br/>ãƒ»Mock API/DBä½¿ç”¨"]
        F["UseCase Tests<br/>ãƒ»ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«æ¤œè¨¼<br/>ãƒ»è¤‡é›‘ãƒ­ã‚¸ãƒƒã‚¯<br/>ãƒ»å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ"]
        G["Mapper Tests<br/>ãƒ»ãƒ‡ãƒ¼ã‚¿å¤‰æ›ç¢ºèª<br/>ãƒ»nullå®‰å…¨æ€§<br/>ãƒ»å‹å¤‰æ›"]
    end
    
    subgraph TestPatterns ["ğŸ”§ ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³"]
        H["Given-When-Then<br/>ãƒ»å‰ææ¡ä»¶è¨­å®š<br/>ãƒ»å®Ÿè¡Œ<br/>ãƒ»çµæœæ¤œè¨¼"]
        I["Arrange-Act-Assert<br/>ãƒ»æº–å‚™<br/>ãƒ»å®Ÿè¡Œ<br/>ãƒ»æ¤œè¨¼"]
        J["Mock Strategy<br/>ãƒ»å¤–éƒ¨ä¾å­˜Mock<br/>ãƒ»çŠ¶æ…‹æ¤œè¨¼<br/>ãƒ»æŒ¯ã‚‹èˆã„æ¤œè¨¼"]
    end
    
    subgraph TestTools ["ğŸ› ï¸ ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«"]
        K["JUnit5<br/>ãƒ»ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯<br/>ãƒ»ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³<br/>ãƒ»ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«"]
        L["MockK<br/>ãƒ»Mockãƒ©ã‚¤ãƒ–ãƒ©ãƒª<br/>ãƒ»Kotlinå°‚ç”¨<br/>ãƒ»Coroutineså¯¾å¿œ"]
        M["Turbine<br/>ãƒ»Flow/StateFlowãƒ†ã‚¹ãƒˆ<br/>ãƒ»æ™‚ç³»åˆ—æ¤œè¨¼<br/>ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š"]
    end
    
    %% å›³ã®é…ç½®é †åºã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
    TestPyramid --> UnitTestTargets
    UnitTestTargets --> TestPatterns
    TestPatterns --> TestTools
    
    %% ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° - VSCodeå¯¾å¿œ
    classDef pyramidStyle fill:#1976d2,stroke:#0d47a1,stroke-width:3px,color:#ffffff
    classDef targetStyle fill:#388e3c,stroke:#1b5e20,stroke-width:3px,color:#ffffff
    classDef patternStyle fill:#7b1fa2,stroke:#4a148c,stroke-width:3px,color:#ffffff
    classDef toolStyle fill:#f57c00,stroke:#e65100,stroke-width:3px,color:#ffffff
    
    class A,B,C pyramidStyle
    class D,E,F,G targetStyle
    class H,I,J patternStyle
    class K,L,M toolStyle
```

### ğŸ“‹ Unit Testå®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

#### 1. ViewModel ãƒ†ã‚¹ãƒˆ - StateFlowçŠ¶æ…‹å¤‰åŒ–ã®ãƒ†ã‚¹ãƒˆ
```kotlin
// ã“ã®ãƒ†ã‚¹ãƒˆã®ç›®çš„: ViewModelã®loadUsers()ãƒ¡ã‚½ãƒƒãƒ‰ãŒæ­£ã—ã„é †åºã§çŠ¶æ…‹ã‚’å¤‰åŒ–ã•ã›ã‚‹ã“ã¨ã‚’æ¤œè¨¼
@Test
fun `loadUsers should emit loading then success`() = runTest {
    // å›³ã®ã€ŒGiven-When-Thenã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Givenï¼ˆå‰ææ¡ä»¶è¨­å®šï¼‰
    val users = listOf(mockUser) // æœŸå¾…ã™ã‚‹æˆåŠŸæ™‚ã®ãƒ‡ãƒ¼ã‚¿
    // å›³ã®ã€ŒMock Strategyã€ - å¤–éƒ¨ä¾å­˜Mock
    coEvery { repository.getUsers() } returns flowOf(users)
    
    // å›³ã®ã€ŒGiven-When-Thenã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Whenï¼ˆå®Ÿè¡Œï¼‰
    viewModel.loadUsers() // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—å‡¦ç†ã‚’å®Ÿè¡Œ
    
    // å›³ã®ã€ŒGiven-When-Thenã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Thenï¼ˆçµæœæ¤œè¨¼ï¼‰
    // å›³ã®ã€ŒViewModel Testsã€ - StateFlowå‹•ä½œç¢ºèª
    viewModel.uiState.test {
        // æœ€åˆã«LoadingçŠ¶æ…‹ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆèª­ã¿è¾¼ã¿é–‹å§‹ï¼‰
        assertEquals(UiState.Loading, awaitItem())
        // æ¬¡ã«SuccessçŠ¶æ…‹ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆèª­ã¿è¾¼ã¿å®Œäº†ï¼‰
        assertEquals(UiState.Success(users), awaitItem())
    }
    // ã“ã®ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚Šã€UIä¸Šã§æ­£ã—ããƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºâ†’æˆåŠŸè¡¨ç¤ºã®æµã‚ŒãŒç¢ºèªã§ãã‚‹
}
```

#### 2. Repository ãƒ†ã‚¹ãƒˆ - ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®ãƒ†ã‚¹ãƒˆ
```kotlin
// ã“ã®ãƒ†ã‚¹ãƒˆã®ç›®çš„: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ãªæ™‚ã«ãƒªãƒ¢ãƒ¼ãƒˆAPIã‚’å‘¼ã°ãšã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ã“ã¨ã‚’æ¤œè¨¼
@Test
fun `getUsers should return cached data when cache is valid`() = runTest {
    // å›³ã®ã€ŒArrange-Act-Assertã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Arrangeï¼ˆæº–å‚™ï¼‰
    val cachedUsers = listOf(mockUser) // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿
    // å›³ã®ã€ŒMock Strategyã€ - å¤–éƒ¨ä¾å­˜Mock
    coEvery { localDataSource.getUsers() } returns cachedUsers
    // å›³ã®ã€ŒRepository Testsã€ - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼
    coEvery { localDataSource.isCacheValid() } returns true
    
    // å›³ã®ã€ŒArrange-Act-Assertã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Actï¼ˆå®Ÿè¡Œï¼‰
    val result = repository.getUsers().first() // æœ€åˆã«å‡ºåŠ›ã•ã‚Œã‚‹å€¤ã‚’å–å¾—
    
    // å›³ã®ã€ŒArrange-Act-Assertã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Assertï¼ˆæ¤œè¨¼ï¼‰
    // è¿”ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    assertEquals(cachedUsers, result)
    // å›³ã®ã€ŒMock Strategyã€ - æŒ¯ã‚‹èˆã„æ¤œè¨¼
    coVerify(exactly = 0) { remoteDataSource.getUsers() }
    // ã“ã®ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚Šã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
}
```

#### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆä¾‹
```kotlin
// ã“ã®ãƒ†ã‚¹ãƒˆã®ç›®çš„: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã«ãªã‚‹ã“ã¨ã‚’æ¤œè¨¼
@Test
fun `loadUsers should emit error when network fails`() = runTest {
    // å›³ã®ã€ŒGiven-When-Thenã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Givenï¼ˆå‰ææ¡ä»¶è¨­å®šï¼‰
    val networkException = IOException("Network error")
    // å›³ã®ã€ŒMock Strategyã€ - å¤–éƒ¨ä¾å­˜Mock
    coEvery { repository.getUsers() } throws networkException
    
    // å›³ã®ã€ŒGiven-When-Thenã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Whenï¼ˆå®Ÿè¡Œï¼‰
    viewModel.loadUsers()
    
    // å›³ã®ã€ŒGiven-When-Thenã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Thenï¼ˆçµæœæ¤œè¨¼ï¼‰
    // å›³ã®ã€ŒViewModel Testsã€ - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ¤œè¨¼
    viewModel.uiState.test {
        assertEquals(UiState.Loading, awaitItem()) // ã¾ãšLoadingçŠ¶æ…‹
        // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã«ãªã‚Šã€ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
        val errorState = awaitItem() as UiState.Error
        assertEquals(true, errorState.canRetry) // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¯ãƒªãƒˆãƒ©ã‚¤å¯èƒ½
        assertTrue(errorState.message.contains("Network")) // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«Networkå«ã¾ã‚Œã‚‹
    }
    // ã“ã®ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚Šã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒªãƒˆãƒ©ã‚¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
}
```

#### 4. Result APIã‚’ä½¿ã£ãŸRepositoryãƒ†ã‚¹ãƒˆä¾‹
```kotlin
// ã“ã®ãƒ†ã‚¹ãƒˆã®ç›®çš„: Result APIã‚’ä½¿ã£ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
@Test
fun `refreshUsers should return failure Result when API call fails`() = runTest {
    // å›³ã®ã€ŒGiven-When-Thenã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Givenï¼ˆå‰ææ¡ä»¶è¨­å®šï¼‰
    val networkError = IOException("Network error")
    // å›³ã®ã€ŒMock Strategyã€ - Mock API/DBä½¿ç”¨
    coEvery { userApi.getUsers() } throws networkError
    
    // å›³ã®ã€ŒGiven-When-Thenã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Whenï¼ˆå®Ÿè¡Œï¼‰
    val result = repository.refreshUsers()
    
    // å›³ã®ã€ŒGiven-When-Thenã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Thenï¼ˆçµæœæ¤œè¨¼ï¼‰
    // å›³ã®ã€ŒRepository Testsã€ - ãƒ‡ãƒ¼ã‚¿å¤‰æ›ç¢ºèª
    assertTrue(result.isFailure) // å¤±æ•—ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒAppErrorã«å¤‰æ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    result.onFailure { throwable ->
        assertTrue(throwable.message?.contains("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼") == true)
    }
    
    // å›³ã®ã€ŒMock Strategyã€ - æŒ¯ã‚‹èˆã„æ¤œè¨¼
    coVerify(exactly = 0) { userDao.deleteAllUsers() }
    coVerify(exactly = 0) { userDao.insertUsers(any()) }
    
    // ã“ã®ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚Šã€Result APIãƒ™ãƒ¼ã‚¹ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒ
    // é©åˆ‡ã«ã‚¨ãƒ©ãƒ¼ã‚’ä¼æ’­ã—ã€å‰¯ä½œç”¨ï¼ˆDBæ›´æ–°ï¼‰ã‚’é˜²ãã“ã¨ã‚’ç¢ºèª
}

// Result.successã®ãƒ†ã‚¹ãƒˆä¾‹
@Test
fun `refreshUsers should return success Result when API call succeeds`() = runTest {
    // å›³ã®ã€ŒGiven-When-Thenã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Givenï¼ˆå‰ææ¡ä»¶è¨­å®šï¼‰
    val userDtos = listOf(mockUserDto)
    // å›³ã®ã€ŒMock Strategyã€ - Mock API/DBä½¿ç”¨
    coEvery { userApi.getUsers() } returns userDtos
    coEvery { userDao.deleteAllUsers() } just Runs
    coEvery { userDao.insertUsers(any()) } just Runs
    
    // å›³ã®ã€ŒGiven-When-Thenã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Whenï¼ˆå®Ÿè¡Œï¼‰
    val result = repository.refreshUsers()
    
    // å›³ã®ã€ŒGiven-When-Thenã€ãƒ‘ã‚¿ãƒ¼ãƒ³ - Thenï¼ˆçµæœæ¤œè¨¼ï¼‰
    // å›³ã®ã€ŒRepository Testsã€ - ãƒ‡ãƒ¼ã‚¿å¤‰æ›ç¢ºèª
    assertTrue(result.isSuccess)
    
    // å›³ã®ã€ŒMock Strategyã€ - æŒ¯ã‚‹èˆã„æ¤œè¨¼
    coVerify(exactly = 1) { userDao.deleteAllUsers() }
    coVerify(exactly = 1) { userDao.insertUsers(any()) }
}
```

#### 5. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•

##### Android Studio ã§ã®å®Ÿè¡Œ
1. **å˜ä¸€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ**: ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰æ¨ªã®ç·‘è‰²ã®â–¶ï¸ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. **ã‚¯ãƒ©ã‚¹å…¨ä½“ã®å®Ÿè¡Œ**: ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹åæ¨ªã®â–¶ï¸ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
3. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨ä½“ã®å®Ÿè¡Œ**: Project ãƒ‘ãƒãƒ«ã§ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ "Run Tests"

##### ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§ã®å®Ÿè¡Œ
```bash
# å…¨ã¦ã®Unit Testã‚’å®Ÿè¡Œ
./gradlew testDebugUnitTest

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®ã¿å®Ÿè¡Œ
./gradlew testDebugUnitTest --tests "com.example.UserViewModelTest"

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿å®Ÿè¡Œ
./gradlew testDebugUnitTest --tests "com.example.UserViewModelTest.loadUsers should emit loading then success"

# ãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
./gradlew testDebugUnitTest --html
# â†’ build/reports/tests/testDebugUnitTest/index.html ã§ãƒ¬ãƒãƒ¼ãƒˆç¢ºèªå¯èƒ½
```

#### 6. ãƒ†ã‚¹ãƒˆè¨­è¨ˆåŸå‰‡
- **å˜ä¸€è²¬ä»»**: 1ã¤ã®ãƒ†ã‚¹ãƒˆã§1ã¤ã®æ©Ÿèƒ½ã®ã¿æ¤œè¨¼
- **ç‹¬ç«‹æ€§**: ãƒ†ã‚¹ãƒˆé–“ã§çŠ¶æ…‹ã‚’å…±æœ‰ã—ãªã„
- **å¯èª­æ€§**: ãƒ†ã‚¹ãƒˆåã¨æ§‹é€ ã§æ„å›³ã‚’æ˜ç¢ºã«
- **é«˜é€Ÿå®Ÿè¡Œ**: å¤–éƒ¨ä¾å­˜ã¯å…¨ã¦Mockã§ç½®ãæ›ãˆ

## é–‹ç™ºæ™‚ã®é‡è¦åŸå‰‡

### è¨­è¨ˆåŸå‰‡
- **Single Responsibility**: å„ã‚¯ãƒ©ã‚¹ã¯å˜ä¸€ã®è²¬ä»»ã‚’æŒã¤
- **Dependency Inversion**: æŠ½è±¡ã«ä¾å­˜ã—ã€å…·è±¡ã«ä¾å­˜ã—ãªã„
- **Testability**: ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„è¨­è¨ˆã‚’å¿ƒãŒã‘ã‚‹
- **Consistency**: æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã®ä¸€è²«æ€§ã‚’ä¿ã¤

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼åŸå‰‡
- **Unidirectional**: ãƒ‡ãƒ¼ã‚¿ã¯ä¸€æ–¹å‘ã«æµã‚Œã‚‹
- **Immutable State**: çŠ¶æ…‹ã¯ä¸å¤‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ç®¡ç†
- **Reactive**: Flow/StateFlowã«ã‚ˆã‚‹ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°
- **Error Handling**: çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŸå‰‡
- **Lazy Loading**: å¿…è¦ãªæ™‚ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
- **Caching Strategy**: é©åˆ‡ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
- **Background Processing**: UI ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
- **Memory Management**: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®é˜²æ­¢

## Architecture4: Kotlin Coroutinesè¨­è¨ˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### ğŸ”„ Coroutinesã¨ã¯ï¼ŸåŸºæœ¬æ¦‚å¿µ

**Kotlin Coroutines** ã¯ã€éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’ç°¡æ½”ã‹ã¤å®‰å…¨ã«è¨˜è¿°ã§ãã‚‹ä»•çµ„ã¿ã§ã™ã€‚å¾“æ¥ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚„RxJavaã«ä»£ã‚ã‚‹ã€Kotlinã®æ¨™æº–çš„ãªéåŒæœŸå‡¦ç†ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

#### ğŸ¯ CoroutinesãŒè§£æ±ºã™ã‚‹å•é¡Œ

**å¾“æ¥ã®éåŒæœŸå‡¦ç†ã®å•é¡Œï¼š**
```kotlin
// âŒ ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯åœ°ç„
getUserFromApi(userId) { user ->
    getPostsFromApi(user.id) { posts ->
        getCommentsFromApi(posts[0].id) { comments ->
            // ãƒã‚¹ãƒˆãŒæ·±ããªã‚Šã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå›°é›£
            updateUI(user, posts, comments)
        }
    }
}

// âŒ ã‚¹ãƒ¬ãƒƒãƒ‰ç®¡ç†ã®è¤‡é›‘ã•
Thread {
    val result = networkCall() // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ãƒ¬ãƒƒãƒ‰
    runOnUiThread {
        updateUI(result) // UIã‚¹ãƒ¬ãƒƒãƒ‰ã«æˆ»ã™
    }
}.start()
```

**Coroutinesã«ã‚ˆã‚‹è§£æ±ºï¼š**
```kotlin
// âœ… é †æ¬¡å®Ÿè¡Œã®ã‚ˆã†ãªèª­ã¿ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰
suspend fun loadUserData(userId: Int) {
    val user = getUserFromApi(userId)        // éåŒæœŸå‡¦ç†ã ãŒé †æ¬¡å®Ÿè¡Œã®ã‚ˆã†ã«æ›¸ã‘ã‚‹
    val posts = getPostsFromApi(user.id)     // å‰ã®å‡¦ç†å®Œäº†ã‚’å¾…ã¤
    val comments = getCommentsFromApi(posts[0].id)
    updateUI(user, posts, comments)          // è‡ªå‹•çš„ã«UIã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
}
```

#### ğŸ“š Coroutinesã®åŸºæœ¬ç”¨èª

| ç”¨èª | èª¬æ˜ | ä¾‹ |
|------|------|-----|
| **suspend function** | ä¸­æ–­å¯èƒ½ãªé–¢æ•°ã€‚ã‚³ãƒ«ãƒ¼ãƒãƒ³å†…ã§ã®ã¿å‘¼ã³å‡ºã—å¯èƒ½ | `suspend fun fetchData()` |
| **CoroutineScope** | ã‚³ãƒ«ãƒ¼ãƒãƒ³ã®å®Ÿè¡Œç¯„å›²ã€‚ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç† | `viewModelScope`, `lifecycleScope` |
| **Dispatcher** | ã‚³ãƒ«ãƒ¼ãƒãƒ³ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æŒ‡å®š | `Dispatchers.Main`, `Dispatchers.IO` |
| **Job** | ã‚³ãƒ«ãƒ¼ãƒãƒ³ã®åˆ¶å¾¡ãƒãƒ³ãƒ‰ãƒ«ã€‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚„å®Œäº†å¾…æ©Ÿ | `val job = launch { ... }` |
| **Flow** | éåŒæœŸãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ ã€‚ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° | `Flow<List<User>>` |

#### âš¡ Coroutinesã®ä¸»ãªåˆ©ç‚¹

1. **è»½é‡æ€§**
   - ã‚¹ãƒ¬ãƒƒãƒ‰ã‚ˆã‚Šè»½é‡ï¼ˆãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå°‘ãªã„ï¼‰
   - æ•°åƒã®ã‚³ãƒ«ãƒ¼ãƒãƒ³ã‚’åŒæ™‚å®Ÿè¡Œå¯èƒ½
   - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¤ãƒƒãƒã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå°ã•ã„

2. **æ§‹é€ åŒ–ã•ã‚ŒãŸä¸¦è¡Œæ€§ï¼ˆStructured Concurrencyï¼‰**
   - è¦ªå­é–¢ä¿‚ã«ã‚ˆã‚‹ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
   - è¦ªãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹ã¨å­ã‚‚è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
   - ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®é˜²æ­¢

3. **ä¾‹å¤–å‡¦ç†ã®å®‰å…¨æ€§**
   - æ§‹é€ åŒ–ã•ã‚ŒãŸä¾‹å¤–ä¼æ’­
   - try-catchã§é€šå¸¸ã®ä¾‹å¤–å‡¦ç†ãŒå¯èƒ½
   - SupervisorJobã§ä¾‹å¤–ã®éš”é›¢

4. **èª­ã¿ã‚„ã™ã•**
   - é †æ¬¡å®Ÿè¡Œã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰
   - ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯åœ°ç„ã®è§£æ¶ˆ
   - éåŒæœŸå‡¦ç†ã®è¤‡é›‘ã•ã‚’éš è”½

#### ğŸ§µ ã‚¹ãƒ¬ãƒƒãƒ‰ã¨ã®æ¯”è¼ƒ

| æ¯”è¼ƒé …ç›® | Thread | Coroutine |
|----------|---------|-----------|
| **ä½œæˆã‚³ã‚¹ãƒˆ** | é«˜ã„ï¼ˆ1MBç¨‹åº¦ã®ãƒ¡ãƒ¢ãƒªï¼‰ | ä½ã„ï¼ˆæ•°KBï¼‰ |
| **åŒæ™‚å®Ÿè¡Œæ•°** | åˆ¶é™ã‚ã‚Šï¼ˆæ•°åã€œæ•°ç™¾ï¼‰ | æ•°åƒã€œæ•°ä¸‡å¯èƒ½ |
| **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¤ãƒƒãƒ** | OSä¾å­˜ï¼ˆé‡ã„ï¼‰ | è»½é‡ |
| **ã‚­ãƒ£ãƒ³ã‚»ãƒ«** | è¤‡é›‘ï¼ˆå‰²ã‚Šè¾¼ã¿å‡¦ç†ï¼‰ | ç°¡å˜ï¼ˆæ§‹é€ åŒ–ï¼‰ |
| **ä¾‹å¤–å‡¦ç†** | è¤‡é›‘ | é€šå¸¸ã®try-catch |
| **ãƒ‡ãƒãƒƒã‚°** | å›°é›£ | ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ |

#### ğŸ”€ Dispatchersã®å½¹å‰²

**Dispatchers** ã¯ã€ã‚³ãƒ«ãƒ¼ãƒãƒ³ãŒã©ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‹ã‚’æ±ºå®šã—ã¾ã™ï¼š

```kotlin
// ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆUIæ›´æ–°ï¼‰
Dispatchers.Main
â”œâ”€ UIæ›´æ–°
â”œâ”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
â””â”€ çŸ­æ™‚é–“ã®è¨ˆç®—

// IOã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
Dispatchers.IO
â”œâ”€ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡
â”œâ”€ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿æ›¸ã
â”œâ”€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹
â””â”€ ç”»åƒå‡¦ç†

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆCPUé›†ç´„çš„å‡¦ç†ï¼‰
Dispatchers.Default
â”œâ”€ é‡ã„è¨ˆç®—å‡¦ç†
â”œâ”€ ãƒ‡ãƒ¼ã‚¿å¤‰æ›
â”œâ”€ ã‚½ãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
â””â”€ æš—å·åŒ–å‡¦ç†

// åˆ¶é™ãªã—ï¼ˆæ³¨æ„ã—ã¦ä½¿ç”¨ï¼‰
Dispatchers.Unconfined
â””â”€ ãƒ†ã‚¹ãƒˆç”¨é€”ãªã©ç‰¹æ®Šãªå ´åˆã®ã¿
```

#### ğŸŒŠ Flowã¨ã¯ï¼Ÿ

**Flow** ã¯ã€æ™‚é–“ã‚’ã‹ã‘ã¦è¤‡æ•°ã®å€¤ã‚’éåŒæœŸã§é€å‡ºã§ãã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§ã™ï¼š

```kotlin
// åŸºæœ¬çš„ãªFlow
fun getUsers(): Flow<List<User>> = flow {
    emit(emptyList())           // æœ€åˆã¯ç©ºãƒªã‚¹ãƒˆ
    val users = fetchFromApi()  // APIå‘¼ã³å‡ºã—
    emit(users)                 // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’é€å‡º
}

// Flowã®è³¼èª­
lifecycleScope.launch {
    getUsers().collect { users ->
        updateUI(users) // ãƒ‡ãƒ¼ã‚¿ãŒæµã‚Œã¦ãã‚‹ãŸã³ã«å®Ÿè¡Œ
    }
}
```

**Flowã¨StateFlowã®é•ã„ï¼š**
- **Flow**: Cold Streamï¼ˆè³¼èª­æ™‚ã«å®Ÿè¡Œé–‹å§‹ï¼‰
- **StateFlow**: Hot Streamï¼ˆå¸¸ã«æœ€æ–°å€¤ã‚’ä¿æŒã€è¤‡æ•°è³¼èª­è€…å¯¾å¿œï¼‰

ã“ã‚Œã‚‰ã®åŸºæœ¬æ¦‚å¿µã‚’ç†è§£ã—ãŸä¸Šã§ã€ä»¥ä¸‹ã®è©³ç´°ãªå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```mermaid
flowchart TD
    subgraph CoroutineBasics ["ğŸ”„ CoroutineåŸºæœ¬è¦ç´ "]
        A["CoroutineScope<br/>ãƒ»ã‚³ãƒ«ãƒ¼ãƒãƒ³ã®å®Ÿè¡Œç¯„å›²<br/>ãƒ»è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç®¡ç†<br/>ãƒ»æ§‹é€ åŒ–ã•ã‚ŒãŸä¸¦è¡Œæ€§"]
        B["Dispatcher<br/>ãƒ»å®Ÿè¡Œã‚¹ãƒ¬ãƒƒãƒ‰ã®æŒ‡å®š<br/>ãƒ»Main/IO/Default/Unconfined<br/>ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–"]
        C["suspend function<br/>ãƒ»ä¸­æ–­å¯èƒ½é–¢æ•°<br/>ãƒ»ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°å®Ÿè¡Œ<br/>ãƒ»ã‚³ãƒ«ãƒ¼ãƒãƒ³å†…ã§ã®ã¿å‘¼ã³å‡ºã—å¯èƒ½"]
        D["Job<br/>ãƒ»ã‚³ãƒ«ãƒ¼ãƒãƒ³ã®åˆ¶å¾¡<br/>ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å®Œäº†å¾…æ©Ÿ<br/>ãƒ»è¦ªå­é–¢ä¿‚ç®¡ç†"]
    end
    
    subgraph CoroutineFlow ["ğŸŒŠ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆFlowï¼‰"]
        E["Flow Builder<br/>ãƒ»flow { emit() }<br/>ãƒ»flowOf()<br/>ãƒ»asFlow()"]
        F["Flow Operators<br/>ãƒ»map/filter/combine<br/>ãƒ»collectLatest<br/>ãƒ»stateIn/shareIn"]
        G["StateFlow<br/>ãƒ»çŠ¶æ…‹ä¿æŒ<br/>ãƒ»æœ€æ–°å€¤ã‚’è¨˜æ†¶<br/>ãƒ»UIçŠ¶æ…‹ç®¡ç†ã«æœ€é©"]
        H["SharedFlow<br/>ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡<br/>ãƒ»è¤‡æ•°è³¼èª­è€…å¯¾å¿œ<br/>ãƒ»Hot Stream"]
    end
    
    subgraph CoroutineLifecycle ["â° ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«é€£æº"]
        I["viewModelScope<br/>ãƒ»ViewModelã«ç´ã¥ã<br/>ãƒ»è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«<br/>ãƒ»UIé–¢é€£å‡¦ç†"]
        J["lifecycleScope<br/>ãƒ»Activityã«ç´ã¥ã<br/>ãƒ»ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«é€£å‹•<br/>ãƒ»UIæ›´æ–°å‡¦ç†"]
        K["collectAsStateWithLifecycle<br/>ãƒ»ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«è€ƒæ…®<br/>ãƒ»è‡ªå‹•è³¼èª­åœæ­¢<br/>ãƒ»ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢"]
    end
    
    subgraph ErrorHandling ["âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"]
        L["Result API<br/>ãƒ»onSuccess/onFailure<br/>ãƒ»å‹å®‰å…¨ãªã‚¨ãƒ©ãƒ¼å‡¦ç†<br/>ãƒ»é–¢æ•°å‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ"]
        M["runCatching<br/>ãƒ»Resultå‹ã‚’è¿”ã™<br/>ãƒ»ä¾‹å¤–ã‚’å®‰å…¨ã«ã‚­ãƒ£ãƒƒãƒ<br/>ãƒ»safeApiCallå†…ã§ä½¿ç”¨"]
        N["SupervisorJob<br/>ãƒ»å­ã®å¤±æ•—ã‚’éš”é›¢<br/>ãƒ»éƒ¨åˆ†çš„ãªå¤±æ•—è¨±å®¹<br/>ãƒ»å …ç‰¢æ€§å‘ä¸Š"]
    end
    
    %% é–¢ä¿‚æ€§ã®èª¬æ˜
    %% åŸºæœ¬è¦ç´ ã®é–¢ä¿‚
    A -.->|"provides"| C
    B -.->|"runs on"| C
    C -.->|"creates"| E
    
    %% Flowã®é€£é–
    E -->|"transforms to"| F
    F -->|"converts to"| G
    F -->|"converts to"| H
    
    %% ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã®çµ±åˆ
    A -.->|"creates"| I
    A -.->|"creates"| J
    G -->|"observes with"| K
    
    %% ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±åˆ
    C -.->|"uses"| L
    L -->|"implemented by"| M
    A -.->|"can use"| N
    
    %% ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
    classDef basicsStyle fill:#1976d2,stroke:#0d47a1,stroke-width:3px,color:#ffffff
    classDef flowStyle fill:#388e3c,stroke:#1b5e20,stroke-width:3px,color:#ffffff
    classDef lifecycleStyle fill:#7b1fa2,stroke:#4a148c,stroke-width:3px,color:#ffffff
    classDef errorStyle fill:#d32f2f,stroke:#b71c1c,stroke-width:3px,color:#ffffff
    
    class A,B,C,D basicsStyle
    class E,F,G,H flowStyle
    class I,J,K lifecycleStyle
    class L,M,N errorStyle
```

### ğŸ“‹ Coroutineså®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

#### 1. ViewModelã§ã®Coroutineä½¿ç”¨ä¾‹
```kotlin
@HiltViewModel
class UserListViewModel @Inject constructor(
    private val userRepository: UserRepository,
    private val errorMessageProvider: ErrorMessageProvider
) : ViewModel() {
    
    private val _isLoading = MutableStateFlow(false)
    val isLoading: StateFlow<Boolean> = _isLoading.asStateFlow()
    
    private val _isRefreshing = MutableStateFlow(false)
    val isRefreshing: StateFlow<Boolean> = _isRefreshing.asStateFlow()
    
    // å›³ã®ã€ŒStateFlowã€- çŠ¶æ…‹ä¿æŒã¨æœ€æ–°å€¤ã‚’è¨˜æ†¶
    val users: StateFlow<List<User>> = userRepository.getUsers()
        .stateIn(
            scope = viewModelScope, // å›³ã®ã€ŒviewModelScopeã€- ViewModelã«ç´ã¥ãè‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            started = SharingStarted.WhileSubscribed(5000),
            initialValue = emptyList()
        )
    
    // å›³ã®ã€ŒFlow Operatorsã€- combine ã§è¤‡æ•°ã®StateFlowã‚’çµåˆ
    val uiState: StateFlow<UserListUiState> = combine(
        users, isLoading, isRefreshing, errorMessage, canRetry
    ) { users, loading, refreshing, error, retry ->
        UserListUiState(
            users = users,
            isLoading = loading,
            isRefreshing = refreshing,
            errorMessage = error,
            canRetry = retry,
            isEmpty = users.isEmpty() && !loading && !refreshing
        )
    }.stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(5000),
        initialValue = UserListUiState()
    )
    
    init {
        // å›³ã®ã€ŒViewModelä½œæˆã€- åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®åˆæœŸåŒ–
        loadUsers()
    }
    
    // å›³ã®ã€ŒrunCatchingã€ã®ä»£ã‚ã‚Šã«Result APIã‚’ä½¿ç”¨
    private fun loadUsersInternal(isRefresh: Boolean) {
        viewModelScope.launch { // å›³ã®ã€ŒviewModelScopeã€- ViewModelã«ç´ã¥ãè‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            if (isRefresh) {
                _isRefreshing.value = true
            } else {
                _isLoading.value = true
            }
            
            // å›³ã®ã€Œsuspend functionã€- ä¸­æ–­å¯èƒ½é–¢æ•°ã®å‘¼ã³å‡ºã—ï¼ˆResult APIä½¿ç”¨ï¼‰
            userRepository.refreshUsers()
                .onSuccess {
                    // æˆåŠŸæ™‚ã¯ç‰¹ã«å‡¦ç†ãªã—ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯Flowã§è‡ªå‹•æ›´æ–°ï¼‰
                    Timber.d("Users loaded successfully")
                }
                .onFailure { throwable ->
                    // å›³ã®ã€ŒResult APIã€ã§ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
                    val appError = if (throwable is AppErrorException) {
                        throwable.appError
                    } else {
                        AppError.UnknownError(throwable.message ?: "Unknown error")
                    }
                    
                    _errorMessage.value = errorMessageProvider.getErrorMessage(appError)
                    _canRetry.value = appError.canRetry()
                }
            
            // LoadingçŠ¶æ…‹ã®è§£é™¤
            if (isRefresh) {
                _isRefreshing.value = false
            } else {
                _isLoading.value = false
            }
        }
    }
}
```

#### 2. Repositoryã§ã®éåŒæœŸå‡¦ç†ä¾‹
```kotlin
@Singleton
class UserRepositoryImpl @Inject constructor(
    private val userApi: UserApi,
    private val userDao: UserDao
) : UserRepository {
    
    // å›³ã®ã€ŒFlow Builderã€- DAOã®Flowã‚’ç›´æ¥åˆ©ç”¨ï¼ˆè‡ªå‹•çš„ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’é…ä¿¡ï¼‰
    override fun getUsers(): Flow<List<User>> {
        return userDao.getAllUsers().map { entities ->
            entities.map { it.toDomain() } // å›³ã®ã€ŒFlow Operatorsã€- map ã§å¤‰æ›
        }
    }
    
    // å›³ã®ã€Œsuspend functionã€- ä¸­æ–­å¯èƒ½é–¢æ•°
    override suspend fun refreshUsers(): Result<Unit> {
        Timber.d("Fetching users from API")
        
        // å›³ã®ã€ŒrunCatchingã€ã®ä»£ã‚ã‚Šã«safeApiCallã‚’ä½¿ç”¨ï¼ˆResult APIï¼‰
        return safeApiCall { userApi.getUsers() } // å›³ã®ã€ŒDispatcherã€- å†…éƒ¨ã§Dispatchers.IOä½¿ç”¨
            .mapWithError { userDtos -> // å›³ã®ã€ŒFlow Operatorsã€- mapWithError ã§å¤‰æ›ã¨ã‚¨ãƒ©ãƒ¼å‡¦ç†
                // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›
                val users = userDtos.map { it.toDomain() }
                val entities = users.map { it.toEntity() }
                
                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°
                userDao.deleteAllUsers()
                userDao.insertUsers(entities)
                
                Timber.d("Successfully cached ${users.size} users")
                Unit
            }
    }
    
    // å›³ã®ã€Œsuspend functionã€- è¿½åŠ ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¡ã‚½ãƒƒãƒ‰
    override suspend fun getUserById(id: Int): Result<User?> {
        return runCatching {
            // ãƒ­ãƒ¼ã‚«ãƒ«DBã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
            val userEntity = userDao.getUserById(id)
            userEntity?.toDomain()
        }.fold(
            onSuccess = { user -> Result.success(user) },
            onFailure = { throwable ->
                Timber.e(throwable, "Failed to get user by id: $id")
                val appError = AppError.UnknownError("Failed to get user")
                Result.failure(AppErrorException(appError))
            }
        )
    }
}
```

#### 3. UIï¼ˆComposeï¼‰ã§ã®Coroutineä½¿ç”¨ä¾‹
```kotlin
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun UserListScreen(
    onNavigateToDetail: (Int) -> Unit,
    viewModel: UserListViewModel = hiltViewModel()
) {
    // æ³¨æ„: å®Ÿéš›ã®å®Ÿè£…ã§ã¯ collectAsState ã‚’ä½¿ç”¨
    // ç†æƒ³çš„ã«ã¯ collectAsStateWithLifecycle ã‚’ä½¿ç”¨ã™ã¹ã
    val uiState by viewModel.uiState.collectAsState()
    
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text(stringResource(R.string.user_list_title)) },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = MaterialTheme.colorScheme.primary,
                    titleContentColor = MaterialTheme.colorScheme.onPrimary
                )
            )
        }
    ) { paddingValues ->
        // å›³ã®ã€ŒCompositionã€- Composableé–¢æ•°å®Ÿè¡Œ
        PullToRefreshBox(
            isRefreshing = uiState.isRefreshing,
            onRefresh = viewModel::refresh, // å›³ã®ã€ŒviewModelScopeã€çµŒç”±ã§Coroutineèµ·å‹•
            modifier = Modifier.fillMaxSize()
        ) {
            when {
                uiState.isLoading && uiState.users.isEmpty() -> {
                    // å›³ã®ã€ŒRecompositionã€- çŠ¶æ…‹å¤‰åŒ–ã«ã‚ˆã‚‹å†å®Ÿè¡Œ
                    CircularProgressIndicator(
                        modifier = Modifier.align(Alignment.Center)
                    )
                }
                uiState.isEmpty -> {
                    Text(
                        text = stringResource(R.string.no_data_message),
                        modifier = Modifier.align(Alignment.Center)
                    )
                }
                else -> {
                    LazyColumn {
                        items(uiState.users) { user ->
                            UserItem(
                                user = user,
                                onClick = { onNavigateToDetail(user.id) }
                            )
                        }
                    }
                }
            }
        }
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
    uiState.errorMessage?.let { message ->
        AlertDialog(
            onDismissRequest = { viewModel.clearError() },
            title = { Text(stringResource(R.string.error_title)) },
            text = { Text(message) },
            confirmButton = {
                TextButton(onClick = { viewModel.clearError() }) {
                    Text(stringResource(R.string.ok))
                }
            }
        )
    }
}
```

### ğŸ”§ Coroutinesè¨­è¨ˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

1. **é©åˆ‡ãªScopeä½¿ç”¨**: ViewModelScopeã‚„LifecycleScopeã‚’æ´»ç”¨
2. **DispatcheræŒ‡å®š**: å‡¦ç†å†…å®¹ã«å¿œã˜ãŸé©åˆ‡ãªDispatcheré¸æŠ
3. **æ§‹é€ åŒ–ã•ã‚ŒãŸä¸¦è¡Œæ€§**: è¦ªå­é–¢ä¿‚ã‚’æ´»ç”¨ã—ãŸè‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
4. **Flowæ´»ç”¨**: ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ‡ãƒ¼ã‚¿ç®¡ç†ã«Flowã‚’ä½¿ç”¨
5. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: Result APIã¨runCatchingã§å®‰å…¨æ€§ç¢ºä¿

## Architecture3: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»UIãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

### ğŸ“± Androidãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã®åŸºæœ¬æ¦‚å¿µ

**Androidãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«** ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ç”Ÿæˆã‹ã‚‰ç ´æ£„ã¾ã§ã®çŠ¶æ…‹å¤‰åŒ–ã‚’ç®¡ç†ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚é©åˆ‡ãªãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã«ã‚ˆã‚Šã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚„ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚’é˜²æ­¢ã§ãã¾ã™ã€‚

```mermaid
flowchart TD
    subgraph AppLifecycle ["ğŸŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«"]
        A1["Application.onCreate()<br/>ãƒ»ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘å®Ÿè¡Œ<br/>ãƒ»DIåˆæœŸåŒ–<br/>ãƒ»ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š"]
        A2["Process Start<br/>ãƒ»ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹<br/>ãƒ»ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦<br/>ãƒ»ã‚¯ãƒ©ã‚¹ãƒ­ãƒ¼ãƒ€ãƒ¼åˆæœŸåŒ–"]
        A3["Process Kill<br/>ãƒ»ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†<br/>ãƒ»ãƒ¡ãƒ¢ãƒªè§£æ”¾<br/>ãƒ»ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"]
        
        A2 --> A1
        A1 --> A3
    end
    
    subgraph ActivityLifecycle ["ğŸ  Activityãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«"]
        B1["onCreate()<br/>ãƒ»åˆå›ä½œæˆæ™‚<br/>ãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š<br/>ãƒ»åˆæœŸåŒ–å‡¦ç†"]
        B2["onStart()<br/>ãƒ»ç”»é¢è¡¨ç¤ºé–‹å§‹<br/>ãƒ»å¯è¦–çŠ¶æ…‹<br/>ãƒ»UIæº–å‚™"]
        B3["onResume()<br/>ãƒ»ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–å¾—<br/>ãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹<br/>ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¯èƒ½"]
        B4["onPause()<br/>ãƒ»ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–ªå¤±<br/>ãƒ»ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç§»è¡Œ<br/>ãƒ»å‡¦ç†ä¸€æ™‚åœæ­¢"]
        B5["onStop()<br/>ãƒ»ç”»é¢éè¡¨ç¤º<br/>ãƒ»ä¸å¯è¦–çŠ¶æ…‹<br/>ãƒ»é‡ã„å‡¦ç†åœæ­¢"]
        B6["onDestroy()<br/>ãƒ»çµ‚äº†å‡¦ç†<br/>ãƒ»ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾<br/>ãƒ»ãƒ¡ãƒ¢ãƒªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"]
        
        B1 --> B2
        B2 --> B3
        B3 --> B4
        B4 --> B5
        B5 --> B6
        B4 --> B3
        B5 --> B2
    end
    
    subgraph ComposeLifecycle ["ğŸ¨ Composeãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«"]
        C1["Composition<br/>ãƒ»Composableé–¢æ•°å®Ÿè¡Œ<br/>ãƒ»UIãƒ„ãƒªãƒ¼æ§‹ç¯‰<br/>ãƒ»åˆå›æç”»"]
        C2["Recomposition<br/>ãƒ»çŠ¶æ…‹å¤‰åŒ–ã«ã‚ˆã‚‹å†å®Ÿè¡Œ<br/>ãƒ»UIæ›´æ–°<br/>ãƒ»æœ€é©åŒ–ã•ã‚ŒãŸå†æç”»"]
        C3["Disposal<br/>ãƒ»Composableã®ç ´æ£„<br/>ãƒ»ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾<br/>ãƒ»Effectã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"]
        
        C1 --> C2
        C2 --> C1
        C2 --> C3
    end
    
    subgraph ViewModelLifecycle ["ğŸ§  ViewModelãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«"]
        D1["ViewModelä½œæˆ<br/>ãƒ»åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚<br/>ãƒ»ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–<br/>ãƒ»Repositoryæ¥ç¶š"]
        D2["ViewModelä½¿ç”¨<br/>ãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹<br/>ãƒ»ãƒ‡ãƒ¼ã‚¿æä¾›<br/>ãƒ»çŠ¶æ…‹ç®¡ç†"]
        D3["onCleared()<br/>ãƒ»ViewModelScopeè‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«<br/>ãƒ»ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾<br/>ãƒ»è³¼èª­åœæ­¢"]
        
        D1 --> D2
        D2 --> D3
    end
    
    %% é–¢ä¿‚æ€§
    A1 -.->|supports| B1
    B2 -.->|triggers| C1
    B3 -.->|activates| D1
    B4 -.->|may trigger| C3
    B6 -.->|triggers| D3
    
    %% ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
    classDef appStyle fill:#ff9800,stroke:#e65100,stroke-width:3px,color:#ffffff
    classDef activityStyle fill:#1976d2,stroke:#0d47a1,stroke-width:3px,color:#ffffff
    classDef composeStyle fill:#4caf50,stroke:#2e7d32,stroke-width:3px,color:#ffffff
    classDef viewModelStyle fill:#9c27b0,stroke:#6a1b9a,stroke-width:3px,color:#ffffff
    
    class A1,A2,A3 appStyle
    class B1,B2,B3,B4,B5,B6 activityStyle
    class C1,C2,C3 composeStyle
    class D1,D2,D3 viewModelStyle
```

### ğŸ“‹ ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

#### 1. ViewModelã§ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«è€ƒæ…®
```kotlin
class UserListViewModel @Inject constructor(
    private val repository: UserRepository
) : ViewModel() {
    
    private val _uiState = MutableStateFlow(UserListUiState())
    val uiState: StateFlow<UserListUiState> = _uiState.asStateFlow()
    
    init {
        // å›³ã®ã€ŒViewModelä½œæˆã€- åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®åˆæœŸåŒ–
        loadUsers()
    }
    
    fun loadUsers() {
        // å›³ã®ã€ŒViewModelä½¿ç”¨ã€- viewModelScopeã§è‡ªå‹•ç®¡ç†
        viewModelScope.launch {
            repository.getUsers()
                .collect { users ->
                    _uiState.update { 
                        it.copy(users = users, isLoading = false)
                    }
                }
        }
    }
    
    // å›³ã®ã€ŒonCleared()ã€- ViewModelScopeè‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    override fun onCleared() {
        super.onCleared()
        // viewModelScopeå†…ã®ã™ã¹ã¦ã®CoroutineãŒè‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹
        Timber.d("ViewModel cleared, all coroutines cancelled")
    }
}
```

#### 2. Composeã§ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
```kotlin
@Composable
fun UserListScreen(
    viewModel: UserListViewModel = hiltViewModel()
) {
    // å›³ã®ã€ŒCompositionã€- Composableé–¢æ•°å®Ÿè¡Œ
    val uiState by viewModel.uiState.collectAsStateWithLifecycle()
    
    // ä¸€å›é™ã‚Šã®å‡¦ç† - Componentã«Lifecycleé€£å‹•
    LaunchedEffect(Unit) {
        // å›³ã®ã€ŒActivityãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã€ã®onResumeç›¸å½“
        viewModel.loadUsers()
    }
    
    // ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã«å¿œã˜ãŸå‡¦ç†
    DisposableEffect(Unit) {
        // ãƒªã‚½ãƒ¼ã‚¹å–å¾—
        val listener = SomeListener()
        
        onDispose {
            // å›³ã®ã€ŒDisposalã€- ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾
            listener.cleanup()
        }
    }
    
    // çŠ¶æ…‹å¤‰åŒ–ã«ã‚ˆã‚‹å†æç”»
    when {
        uiState.isLoading -> {
            // å›³ã®ã€ŒRecompositionã€- çŠ¶æ…‹å¤‰åŒ–ã«ã‚ˆã‚‹å†å®Ÿè¡Œ
            LoadingIndicator()
        }
        uiState.users.isNotEmpty() -> {
            UserList(users = uiState.users)
        }
        else -> {
            EmptyMessage()
        }
    }
}
```

#### 3. Repositoryã§ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«è€ƒæ…®
```kotlin
@Singleton
class UserRepositoryImpl @Inject constructor(
    private val userApi: UserApi,
    private val userDao: UserDao,
    @ApplicationContext private val context: Context
) : UserRepository {
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚³ãƒ¼ãƒ—ã§ç®¡ç†
    private val applicationScope = CoroutineScope(
        Dispatchers.IO + SupervisorJob()
    )
    
    // å›³ã®ã€ŒApplication.onCreate()ã€å¾Œã«åˆ©ç”¨å¯èƒ½
    override fun getUsers(): Flow<List<User>> = 
        userDao.getAllUsers()
            .map { entities -> entities.map { it.toDomain() } }
            .flowOn(Dispatchers.IO)
    
    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†
    override suspend fun refreshUsers(): Result<Unit> = withContext(Dispatchers.IO) {
        runCatching {
            // å›³ã®ã€ŒProcessã€ãƒ¬ãƒ™ãƒ«ã§ã®å‡¦ç†
            val userDtos = userApi.getUsers()
            val users = userDtos.map { it.toDomain() }
            val entities = users.map { it.toEntity() }
            
            userDao.deleteAllUsers()
            userDao.insertUsers(entities)
        }
    }
}
```

#### 4. Applicationè¨­å®šä¾‹
```kotlin
@HiltAndroidApp
class AndroidBaseApplication : Application() {
    
    // å›³ã®ã€ŒApplication.onCreate()ã€- ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘å®Ÿè¡Œ
    override fun onCreate() {
        super.onCreate()
        initTimber() // å®Ÿéš›ã®å®Ÿè£…ã«åˆã‚ã›ã¦ä¿®æ­£
    }
    
    // å›³ã®ã€ŒApplication.onCreate()ã€å†…ã§å‘¼ã°ã‚Œã‚‹ãƒ­ã‚°åˆæœŸåŒ–
    private fun initTimber() {
        if (BuildConfig.DEBUG) {
            Timber.plant(Timber.DebugTree())
            Timber.d("Timber initialized for debug build")
        }
    }
}
```

### ğŸ”§ ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

1. **é©åˆ‡ãªScopeé¸æŠ**: å‡¦ç†ã®å¯¿å‘½ã«å¿œã˜ãŸCoroutineScopeã‚’ä½¿ç”¨
2. **collectAsStateWithLifecycle**: UIã§ã®Flowè³¼èª­æ™‚ã¯å¿…é ˆ
3. **LaunchedEffect**: ä¸€å›é™ã‚Šã®å‡¦ç†ã«ä½¿ç”¨
4. **DisposableEffect**: ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ãŒå¿…è¦ãªå ´åˆã«ä½¿ç”¨
5. **ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢**: é©åˆ‡ãªãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã§ãƒªãƒ¼ã‚¯ã‚’é˜²æ­¢

### âš ï¸ ã‚ˆãã‚ã‚‹å•é¡Œã¨å¯¾ç­–

#### å•é¡Œ1: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯
```kotlin
// âŒ æ‚ªã„ä¾‹ - GlobalScopeã¯é¿ã‘ã‚‹
GlobalScope.launch {
    // ActivityãŒç ´æ£„ã•ã‚Œã¦ã‚‚å‡¦ç†ãŒç¶šã
}

// âœ… è‰¯ã„ä¾‹ - é©åˆ‡ãªScopeã‚’ä½¿ç”¨
viewModelScope.launch {
    // ViewModelã¨ä¸€ç·’ã«è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
}
```

#### å•é¡Œ2: UIã‚¹ãƒ¬ãƒƒãƒ‰ãƒ–ãƒ­ãƒƒã‚¯
```kotlin
// âŒ æ‚ªã„ä¾‹ - runBlockingã‚’UIã§ä½¿ç”¨
runBlocking {
    repository.getUsers() // UIã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯
}

// âœ… è‰¯ã„ä¾‹ - éåŒæœŸã§å‡¦ç†
LaunchedEffect(Unit) {
    repository.getUsers().collect { users ->
        // UIæ›´æ–°
    }
}
```

#### å•é¡Œ3: ä¸é©åˆ‡ãªrecomposition
```kotlin
// âŒ ç¾åœ¨ã®å®Ÿè£… - ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«æœªè€ƒæ…®ï¼ˆæ”¹å–„æ¨å¥¨ï¼‰
val uiState by viewModel.uiState.collectAsState()

// âœ… æ¨å¥¨å®Ÿè£… - ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«è€ƒæ…®ï¼ˆå°†æ¥çš„ãªæ”¹å–„ï¼‰
val uiState by viewModel.uiState.collectAsStateWithLifecycle()
```

**æ³¨æ„**: ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ `collectAsState` ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ã®ãŸã‚ `collectAsStateWithLifecycle` ã¸ã®ç§»è¡Œã‚’æ¨å¥¨ã—ã¾ã™ã€‚